/* global isDescendant */
// eslint-disable-next-line no-unused-vars
function openUpgradeModal(hasSubscription = false) {
  chrome.storage.local.get(['STRIPE_PAYMENT_LINK_ID', 'STRIPE_PORTAL_LINK_ID'], ({ STRIPE_PAYMENT_LINK_ID, STRIPE_PORTAL_LINK_ID }) => {
    chrome.storage.sync.get(['email'], ({ email }) => {
      const upgradeModal = `<div id="upgrade-to-pro-modal" class="absolute inset-0" style="z-index:100000;"><div data-state="open" class="fixed inset-0 bg-black/50 dark:bg-gray-600/70" style="pointer-events:auto"><div class="grid-cols-[10px_1fr_10px] grid h-full w-full grid-rows-[minmax(10px,_1fr)_auto_minmax(10px,_1fr)] md:grid-rows-[minmax(20px,_1fr)_auto_minmax(20px,_1fr)] overflow-y-auto"><div role="dialog" id="radix-:R15dm:" aria-describedby="radix-:R15dmH2:" aria-labelledby="radix-:R15dmH1:" data-state="open" class="relative col-auto col-start-2 row-auto row-start-2 w-full rounded-xl text-left shadow-xl transition-all left-1/2 -translate-x-1/2 bg-white dark:bg-gray-900 focus-none !bg-transparent !shadow-none outline-none md:max-w-4xl lg:w-full" tabindex="-1" style="pointer-events:auto"><div class=""><div class="focus-none flex h-full flex-col items-center justify-start outline-none"><div class="relative"><div id="upgrade-to-pro-modal-content" class="flex grow justify-center bg-white dark:bg-gray-900 rounded-md flex-col items-start overflow-hidden border shadow-md dark:border-gray-600"><div class="flex w-full flex-row items-center justify-between border-b border-token-border-light bg-token-surface-secondary px-8 py-6"><span class="text-xl font-medium">${hasSubscription ? 'Superpower ChatGPT Pro Plan' : 'Upgrade Superpower ChatGPT Plan'}</span><button id="upgrade-modal-close-button" class="text-token-text-primary opacity-50 transition hover:opacity-75"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="flex flex-col md:flex-row">${hasSubscription ? '' : '<div class="text-sm relative flex-1 flex gap-5 flex-col border-t py-4 px-6 border-token-border-light md:border-r last:border-r-0 md:border-t-0"><div class="relative flex flex-col bg-token-surface-primary"><div class="flex flex-col gap-1"><p class="flex items-center gap-2 text-xl font-medium">Free</p><p class="text-base font-light text-token-text-tertiary">USD $0/month</p></div></div><div class="relative flex flex-col bg-token-surface-primary"><button class="opacity-50 hover:bg-inherit cursor-not-allowed btn relative btn-disabled py-3 font-semibold" disabled=""><div class="flex w-full gap-2 items-center justify-center">Your current plan</div></button></div><div class="flex flex-col flex-grow gap-2"><div class="relative flex flex-col bg-token-surface-primary"><p class="text-l font-medium">For people just getting started with Superpower ChatGPT</p></div><div class="relative bg-token-surface-primary"><div class="text-l flex justify-start gap-2"><div class="w-8 flex-shrink-0"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-2 mt-1 h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><polyline points="20 6 9 17 4 12"></polyline></svg></div><span>Create Folders and Search All Conversations</span></div></div><div class="relative bg-token-surface-primary"><div class="text-l flex justify-start gap-2"><div class="w-8 flex-shrink-0"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-2 mt-1 h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><polyline points="20 6 9 17 4 12"></polyline></svg></div><span>Unlimited Custom Instruction Profiles</span></div></div><div class="relative bg-token-surface-primary"><div class="text-l flex justify-start gap-2"><div class="w-8 flex-shrink-0"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-2 mt-1 h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><polyline points="20 6 9 17 4 12"></polyline></svg></div><span>Prompt Chains, Prompt Templates, and Custom Prompts</span></div></div><div class="relative bg-token-surface-primary"><div class="text-l flex justify-start gap-2"><div class="w-8 flex-shrink-0"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-2 mt-1 h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><polyline points="20 6 9 17 4 12"></polyline></svg></div><span>Change Model Mid Conversation</span></div></div><div class="relative bg-token-surface-primary"><div class="text-l flex justify-start gap-2"><div class="w-8 flex-shrink-0"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-2 mt-1 h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><polyline points="20 6 9 17 4 12"></polyline></svg></div><span>Prompt History, Favorite Prompts, and Community Prompts</span></div></div><div class="relative bg-token-surface-primary"><div class="text-l flex justify-start gap-2"><div class="w-8 flex-shrink-0"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-2 mt-1 h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><polyline points="20 6 9 17 4 12"></polyline></svg></div><span>Auto Splitter and Auto Summarizer</span></div></div><div class="relative bg-token-surface-primary"><div class="text-l flex justify-start gap-2"><div class="w-8 flex-shrink-0"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-2 mt-1 h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><polyline points="20 6 9 17 4 12"></polyline></svg></div><span>Export Chats in Multiple Formats</span></div></div></div></div>'}<div class="text-sm relative flex-1 flex gap-5 flex-col border-t py-4 px-6 border-token-border-light md:border-r last:border-r-0 md:border-t-0"><div class="relative flex flex-col bg-token-surface-primary"><div class="flex flex-col gap-1"><p class="flex items-center gap-2 text-xl font-medium"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" style="width:20px;height:20px;margin-right:6px" stroke="gold" fill="gold"><path d="M240.5 224H352C365.3 224 377.3 232.3 381.1 244.7C386.6 257.2 383.1 271.3 373.1 280.1L117.1 504.1C105.8 513.9 89.27 514.7 77.19 505.9C65.1 497.1 60.7 481.1 66.59 467.4L143.5 288H31.1C18.67 288 6.733 279.7 2.044 267.3C-2.645 254.8 .8944 240.7 10.93 231.9L266.9 7.918C278.2-1.92 294.7-2.669 306.8 6.114C318.9 14.9 323.3 30.87 317.4 44.61L240.5 224z"/></svg>Pro</p><p class="text-base font-light text-token-text-tertiary">USD $19.99/month</p></div></div><div class="relative flex flex-col bg-token-surface-primary"><div class="relative w-full"><span class="" data-state="closed"><button id="upgrade-modal-confirm-button" class="btn relative btn-primary w-full py-3 py-3 font-semibold ${hasSubscription ? 'opacity-50 hover:bg-inherit cursor-not-allowed btn-disabled' : ''}" data-testid="select-plan-button-plus-waitlist">${hasSubscription ? '<div class="flex w-full gap-2 items-center justify-center">Your current plan</div>' : `<a class="flex w-full items-center justify-center" target="_self" href="https://buy.stripe.com/${STRIPE_PAYMENT_LINK_ID}?prefilled_email=${encodeURIComponent(email)}">Upgrade to Pro</a>`}</button></span></div></div><div class="flex flex-col flex-grow gap-2"><div class="relative flex flex-col bg-token-surface-primary">${hasSubscription ? '' : '<p class="text-l font-medium">Everything in Free, and:</p>'}</div><div class="relative bg-token-surface-primary"><div class="text-l flex justify-start gap-2"><div class="w-8 flex-shrink-0"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-2 mt-1 h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><polyline points="20 6 9 17 4 12"></polyline></svg></div><span>Custom GPT Store. <a style="text-decoration:underline;color:gold" href="https://www.youtube.com/watch?v=q1VUONah6fE&ab_channel=Superpower" target="blank">Watch Demo ➜</a></span></div></div><div class="relative bg-token-surface-primary"><div class="text-l flex justify-start gap-2"><div class="w-8 flex-shrink-0"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-2 mt-1 h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><polyline points="20 6 9 17 4 12"></polyline></svg></div><span>Image gallery. Search, See Prompt and Download all Images in One Place. <a style="text-decoration:underline;color:gold" href="https://www.youtube.com/watch?v=oU6_wgJLYEM&ab_channel=Superpower" target="blank">Watch Demo ➜</a></span></div></div><div class="relative bg-token-surface-primary"><div class="text-l flex justify-start gap-2"><div class="w-8 flex-shrink-0"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-2 mt-1 h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><polyline points="20 6 9 17 4 12"></polyline></svg></div><span>Auto Group Custom GPT Chats in Seperate Folders. <a style="text-decoration:underline;color:gold" href="https://www.youtube.com/watch?v=lCCyDwJFoOo&ab_channel=Superpower" target="blank">Watch Demo ➜</a></span></div></div><div class="relative bg-token-surface-primary"><div class="text-l flex justify-start gap-2"><div class="w-8 flex-shrink-0"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-2 mt-1 h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><polyline points="20 6 9 17 4 12"></polyline></svg></div><span>Option to Auto Delete Old Chats Based on Time or Number</span></div></div><div class="relative bg-token-surface-primary"><div class="text-l flex justify-start gap-2"><div class="w-8 flex-shrink-0"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-2 mt-1 h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><polyline points="20 6 9 17 4 12"></polyline></svg></div><span>Don't open Superpower Daily tab on Extension Update</span></div></div><div class="relative bg-token-surface-primary"><div class="text-l flex justify-start gap-2"><div class="w-8 flex-shrink-0"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-2 mt-1 h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><polyline points="20 6 9 17 4 12"></polyline></svg></div><span>Priority Support and a Private Channel for Pro Members on Discord</span></div></div><div class="relative bg-token-surface-primary"><div class="text-l flex justify-start gap-2"><div class="w-8 flex-shrink-0"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-2 mt-1 h-4 w-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><polyline points="20 6 9 17 4 12"></polyline></svg></div><span>More coming ...</span></div></div></div>${hasSubscription ? `<div class="relative flex flex-col bg-token-surface-primary text-xs text-token-text-secondary"><div><a class="px-2 underline" href="https://billing.stripe.com/p/login/${STRIPE_PORTAL_LINK_ID}?prefilled_email=${encodeURIComponent(email)}">Manage my subscription</a></div></div>` : ''}</div></div><div class="flex w-full items-center justify-center border-t border-token-border-light bg-token-surface-secondary px-8 py-6"><div class="text-sm text-token-text-primary sm:flex sm:items-center">Have any questions? <a target="_blank" class="mx-1 font-semibold underline" href="mailto:saeed@superpowerdaily.com?subject=Superpower ChatGPT Pro Subscription">Email Us ➜</a></div></div></div></div></div></div></div></div></div></div>`;
      document.body.insertAdjacentHTML('beforeend', upgradeModal);
      const upgradeModalCloseButton = document.getElementById('upgrade-modal-close-button');
      upgradeModalCloseButton.addEventListener('click', () => {
        document.getElementById('upgrade-to-pro-modal').remove();
      });
      // if click anywhere outside the upgrade-to-pro-modal-content, but inside upgrade-to-pro-modal, close the modal
      const upgradeModalContent = document.getElementById('upgrade-to-pro-modal-content');
      document.getElementById('upgrade-to-pro-modal').addEventListener('click', (e) => {
        if (!isDescendant(upgradeModalContent, e.target)) {
          document.getElementById('upgrade-to-pro-modal').remove();
        }
      });
    });
  });
}

function addUpgradeToProSideButton() {
  const existingUpgradeToProSideButton = document.getElementById('upgrade-to-pro-side-button');

  const textAreaElement = document.querySelector('main form textarea');
  if (!textAreaElement) {
    if (existingUpgradeToProSideButton) existingUpgradeToProSideButton.remove();
    return;
  }
  if (existingUpgradeToProSideButton) return;

  const upgradeToProSideButton = document.createElement('button');
  upgradeToProSideButton.id = 'upgrade-to-pro-side-button';
  upgradeToProSideButton.title = 'Upgrade to Pro';
  upgradeToProSideButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" style="width:20px; height:20px;" stroke="purple" fill="purple"><path d="M240.5 224H352C365.3 224 377.3 232.3 381.1 244.7C386.6 257.2 383.1 271.3 373.1 280.1L117.1 504.1C105.8 513.9 89.27 514.7 77.19 505.9C65.1 497.1 60.7 481.1 66.59 467.4L143.5 288H31.1C18.67 288 6.733 279.7 2.044 267.3C-2.645 254.8 .8944 240.7 10.93 231.9L266.9 7.918C278.2-1.92 294.7-2.669 306.8 6.114C318.9 14.9 323.3 30.87 317.4 44.61L240.5 224z"/></svg>';
  upgradeToProSideButton.classList = 'absolute flex flex-wrap p-1 items-center rounded-md bg-gold hover:bg-gold-dark transition-colors duration-200 text-black cursor-pointer text-sm ml-auto font-bold';
  upgradeToProSideButton.style = 'bottom: 14rem;right:3rem;width:2rem;height:2rem;flex-wrap:wrap;border: solid 1px;';

  upgradeToProSideButton.addEventListener('click', () => {
    openUpgradeModal(false);
  });
  document.body.appendChild(upgradeToProSideButton);
}
// eslint-disable-next-line no-unused-vars
function initializeUpgradeButton(hasSubscription) {
  if (hasSubscription) return;
  const observer = new MutationObserver(() => {
    addUpgradeToProSideButton();
  });
  const main = document.querySelector('main');
  observer.observe(main, {
    childList: true,
    subtree: true,
  });
}
